---
// ETF UNSA - Calendar Widget Component
// Author: Ernedin Zajko <ezajko@root.ba>
// License: GPL-2.0-or-later

interface EventItem {
  date: Date;
  url: string;
}

interface Props {
  initialDate?: Date;
  events?: EventItem[];
  class?: string;
}

const { initialDate = new Date(), events = [], class: className } = Astro.props;

// Convert events to serializable format for client-side
// We use a simple object map or array of strings.
// Let's use an array of objects: { date: "YYYY-MM-DD", url: "..." }
const serializedEvents = events.map((e) => {
  const offset = e.date.getTimezoneOffset() * 60000;
  const localDate = new Date(e.date.getTime() - offset).toISOString().split('T')[0];
  return { date: localDate, url: e.url };
});

// Helper for SSR checking
const getEventForDate = (dateStr: string) => {
  return serializedEvents.find((e) => e.date === dateStr);
};

// Server-side initial render data
const year = initialDate.getFullYear();
const month = initialDate.getMonth();

const getCalendarDays = (y: number, m: number) => {
  const firstDay = new Date(y, m, 1);
  const lastDay = new Date(y, m + 1, 0);

  // 0 = Sunday, 1 = Monday ...
  // Adjust to Monday start: 0 = Mon, ... 6 = Sun
  let startDay = firstDay.getDay() - 1;
  if (startDay === -1) startDay = 6;

  const daysInMonth = lastDay.getDate();
  const prevMonthLastDay = new Date(y, m, 0).getDate();
  const days: { day: number; type: 'prev' | 'current' | 'next' }[] = [];

  // Prev month filler
  for (let i = startDay - 1; i >= 0; i--) {
    days.push({ day: prevMonthLastDay - i, type: 'prev' });
  }

  // Current month
  for (let i = 1; i <= daysInMonth; i++) {
    days.push({ day: i, type: 'current' });
  }

  // Next month filler
  const remaining = 42 - days.length;
  for (let i = 1; i <= remaining; i++) {
    days.push({ day: i, type: 'next' });
  }

  return days;
};

const initialDays = getCalendarDays(year, month);

// Locale format for SERVER render
const formatter = new Intl.DateTimeFormat('bs-BA', { month: 'long', year: 'numeric' });
const initialMonthLabel = formatter.format(initialDate);
const capitalizedLabel = initialMonthLabel.charAt(0).toUpperCase() + initialMonthLabel.slice(1);
const today = new Date();
---

<calendar-widget>
  <!-- We put data-events on this div so script can read it easily -->
  <div
    class={`ez-card calendar-widget ${className || ''}`}
    data-year={year}
    data-month={month}
    data-events={JSON.stringify(serializedEvents)}
  >
    <!-- Calendar Header -->
  </div>
  <script>
    interface CalendarEvent {
      date: string;
      url: string;
    }

    // Client-side logic for the widget
    class CalendarWidget extends HTMLElement {
      private year: number;
      private month: number;
      private events: CalendarEvent[];

      constructor() {
        super();
        const widget = this.querySelector('.calendar-widget');
        this.year = parseInt(
          widget?.getAttribute('data-year') || new Date().getFullYear().toString()
        );
        this.month = parseInt(
          widget?.getAttribute('data-month') || new Date().getMonth().toString()
        );

        // Parse events from data attribute
        try {
          this.events = JSON.parse(widget?.getAttribute('data-events') || '[]');
        } catch (e) {
          console.error('Failed to parse calendar events', e);
          this.events = [];
        }
      }

      connectedCallback() {
        this.querySelector('#btn-prev-month')?.addEventListener('click', () =>
          this.changeMonth(-1)
        );
        this.querySelector('#btn-next-month')?.addEventListener('click', () => this.changeMonth(1));
      }

      changeMonth(offset: number) {
        this.month += offset;
        if (this.month < 0) {
          this.month = 11;
          this.year--;
        } else if (this.month > 11) {
          this.month = 0;
          this.year++;
        }
        this.render();
      }

      render() {
        const label = this.querySelector('#calendar-month-label');
        if (label) {
          const date = new Date(this.year, this.month);
          const formatter = new Intl.DateTimeFormat('bs-BA', { month: 'long', year: 'numeric' });
          const formattedLabel = formatter.format(date);
          const capitalizedLabel = formattedLabel.charAt(0).toUpperCase() + formattedLabel.slice(1);
          label.innerHTML = `<i class="bi bi-calendar3 me-2"></i> ${capitalizedLabel}`;
        }

        const tbody = this.querySelector('#calendar-body');
        if (tbody) {
          tbody.innerHTML = this.generateGridHTML();
        }
      }

      generateGridHTML() {
        const firstDay = new Date(this.year, this.month, 1);
        const lastDay = new Date(this.year, this.month + 1, 0);
        let startDay = firstDay.getDay() - 1;
        if (startDay === -1) startDay = 6;
        const daysInMonth = lastDay.getDate();
        const prevMonthLastDay = new Date(this.year, this.month, 0).getDate();

        let html = '';
        let daysBuffer: { day: number; type: 'prev' | 'current' | 'next' }[] = [];

        // Prev month
        for (let i = startDay - 1; i >= 0; i--) {
          daysBuffer.push({ day: prevMonthLastDay - i, type: 'prev' });
        }
        // Current month
        for (let i = 1; i <= daysInMonth; i++) {
          daysBuffer.push({ day: i, type: 'current' });
        }
        // Next month
        const remaining = 42 - daysBuffer.length;
        for (let i = 1; i <= remaining; i++) {
          daysBuffer.push({ day: i, type: 'next' });
        }

        // Generate Rows
        const today = new Date(); // Browser execution time = actual today

        for (let i = 0; i < daysBuffer.length; i += 7) {
          html += '<tr>';
          for (let j = 0; j < 7; j++) {
            const d = daysBuffer[i + j];
            let cellClass = 'py-2 ';

            const isToday =
              d.type === 'current' &&
              this.year === today.getFullYear() &&
              this.month === today.getMonth() &&
              d.day === today.getDate();

            // Client-side event checking
            // Construct precise date YYYY-MM-DD
            let checkY = this.year;
            let checkM = this.month;
            if (d.type === 'prev') {
              checkM = this.month - 1;
              if (checkM < 0) {
                checkM = 11;
                checkY--;
              }
            } else if (d.type === 'next') {
              checkM = this.month + 1;
              if (checkM > 11) {
                checkM = 0;
                checkY++;
              }
            }

            const dateStr = `${checkY}-${String(checkM + 1).padStart(2, '0')}-${String(d.day).padStart(2, '0')}`;
            const eventData = this.events.find((e) => e.date === dateStr);
            const hasEvent = !!eventData;

            if (d.type !== 'current') {
              cellClass += 'text-muted opacity-50';
            } else if (isToday) {
              cellClass +=
                'bg-primary text-white rounded-circle shadow-sm fw-bold position-relative';
            } else if (hasEvent) {
              cellClass += 'fw-bold text-primary position-relative';
            } else {
              cellClass += 'text-dark';
            }

            // Styles
            const style = isToday
              ? 'width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;'
              : '';

            const content = `
                ${d.day}
                ${hasEvent && !isToday ? '<span class="position-absolute bottom-0 start-50 translate-middle-x bg-primary rounded-circle" style="width: 4px; height: 4px; margin-bottom: 4px;"></span>' : ''}
            `;

            let cellContent = '';
            if (hasEvent) {
              // Render as link
              cellContent = `
                    <a href="${eventData?.url}" class="${cellClass} text-decoration-none d-flex align-items-center justify-content-center" style="${isToday ? style : 'width: 100%; height: 100%;'}" title="Vidi dogaÄ‘aj">
                        ${content}
                    </a>
                `;
            } else {
              cellContent = `
                    <span class="${cellClass}" style="${style}">
                         ${content}
                    </span>
                `;
            }

            html += `
              <td class="align-middle">
                <div class="d-inline-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                  ${cellContent}
                </div>
              </td>
            `;
          }
          html += '</tr>';
        }
        return html;
      }
    }

    // Define the custom element
    customElements.define('calendar-widget', CalendarWidget);
  </script>
</calendar-widget>
