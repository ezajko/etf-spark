---
// ThemeSwitcher.astro
---

<div class="dropdown d-inline-block">
  <button
    class="btn btn-link text-white-50 p-2 text-decoration-none dropdown-toggle"
    type="button"
    id="themeDropdown"
    data-bs-toggle="dropdown"
    aria-expanded="false"
    title="Appearance"
  >
    <i class="bi bi-circle-half"></i>
  </button>
  <ul
    class="dropdown-menu dropdown-menu-end p-2"
    aria-labelledby="themeDropdown"
    style="min-width: 220px;"
  >
    <!-- Mode Toggle -->
    <li><h6 class="dropdown-header">Naƒçin rada</h6></li>
    <li class="mb-3 px-2">
      <div class="btn-group w-100" role="group">
        <button
          type="button"
          class="btn btn-sm btn-outline-secondary mode-btn active"
          data-mode="light"
        >
          <i class="bi bi-sun-fill"></i> Light
        </button>
        <button type="button" class="btn btn-sm btn-outline-secondary mode-btn" data-mode="dark">
          <i class="bi bi-moon-stars-fill"></i> Dark
        </button>
      </div>
    </li>

    <li><hr class="dropdown-divider" /></li>

    <!-- High Contrast Toggle -->
    <li class="px-2 d-flex justify-content-between align-items-center">
      <label class="form-check-label small fw-bold mb-0" for="highContrastSwitch">
        <i class="bi bi-eye-fill me-1"></i> Visoki kontrast
      </label>
      <div class="form-check form-switch m-0">
        <input class="form-check-input" type="checkbox" role="switch" id="highContrastSwitch" />
      </div>
    </li>
  </ul>
</div>

<script>
  // --- Initialization ---
  const storedTheme = localStorage.getItem('ez-theme') || 'blue';
  const storedMode = localStorage.getItem('ez-mode') || 'light';
  const hcSwitch = document.getElementById('highContrastSwitch') as HTMLInputElement;

  document.documentElement.setAttribute('data-ez-theme', storedTheme);
  document.documentElement.setAttribute('data-bs-theme', storedMode);

  // Sync Switch UI
  if (hcSwitch) {
    hcSwitch.checked = storedTheme === 'high-contrast';
  }

  // Update Active State for Mode Buttons
  const updateModeButtons = (mode) => {
    document.querySelectorAll('.mode-btn').forEach((btn) => {
      if (btn.getAttribute('data-mode') === mode) {
        btn.classList.add('active', 'btn-secondary');
        btn.classList.remove('btn-outline-secondary');
      } else {
        btn.classList.remove('active', 'btn-secondary');
        btn.classList.add('btn-outline-secondary');
      }
    });
  };

  updateModeButtons(storedMode);

  // --- Event Listeners ---

  // High Contrast Switch
  if (hcSwitch) {
    hcSwitch.addEventListener('change', (e) => {
      const target = e.target as HTMLInputElement;
      const isChecked = target.checked;
      // If checked, set high-contrast. If unchecked, revert to default 'blue'.
      // NOTE: We are intentionally discarding other colored themes logic for this simplified UI.
      const newTheme = isChecked ? 'high-contrast' : 'blue';

      document.documentElement.setAttribute('data-ez-theme', newTheme);
      localStorage.setItem('ez-theme', newTheme);
    });
  }

  // Dark/Light Mode
  document.querySelectorAll('.mode-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const mode = btn.getAttribute('data-mode');
      if (mode) {
        document.documentElement.setAttribute('data-bs-theme', mode);
        localStorage.setItem('ez-mode', mode);
        updateModeButtons(mode);
      }
    });
  });
</script>

<style>
  .theme-btn {
    transition: transform 0.2s;
    cursor: pointer;
  }
  .theme-btn:hover {
    transform: scale(1.2);
  }
  .mode-btn {
    cursor: pointer;
  }
</style>
