---
// ETF UNSA - Calendar Widget Component
// Author: Ernedin Zajko <ezajko@root.ba>
// License: GPL-2.0-or-later

interface EventItem {
  date: Date;
  url: string;
}

interface Props {
  initialDate?: Date;
  events?: EventItem[];
  class?: string;
}

const { initialDate = new Date(), events = [], class: className } = Astro.props;

// Convert events to serializable format for client-side
// We use a simple object map or array of strings.
// Let's use an array of objects: { date: "YYYY-MM-DD", url: "..." }
const serializedEvents = events.map((e) => {
  const offset = e.date.getTimezoneOffset() * 60000;
  const localDate = new Date(e.date.getTime() - offset).toISOString().split('T')[0];
  return { date: localDate, url: e.url };
});

// Helper for SSR checking
const getEventForDate = (dateStr: string) => {
  return serializedEvents.find((e) => e.date === dateStr);
};

// Server-side initial render data
const year = initialDate.getFullYear();
const month = initialDate.getMonth();

const getCalendarDays = (y: number, m: number) => {
  const firstDay = new Date(y, m, 1);
  const lastDay = new Date(y, m + 1, 0);

  // 0 = Sunday, 1 = Monday ...
  // Adjust to Monday start: 0 = Mon, ... 6 = Sun
  let startDay = firstDay.getDay() - 1;
  if (startDay === -1) startDay = 6;

  const daysInMonth = lastDay.getDate();
  const prevMonthLastDay = new Date(y, m, 0).getDate();
  const days: { day: number; type: 'prev' | 'current' | 'next' }[] = [];

  // Prev month filler
  for (let i = startDay - 1; i >= 0; i--) {
    days.push({ day: prevMonthLastDay - i, type: 'prev' });
  }

  // Current month
  for (let i = 1; i <= daysInMonth; i++) {
    days.push({ day: i, type: 'current' });
  }

  // Next month filler
  const remaining = 42 - days.length;
  for (let i = 1; i <= remaining; i++) {
    days.push({ day: i, type: 'next' });
  }

  return days;
};

const initialDays = getCalendarDays(year, month);

// Locale format for SERVER render
const formatter = new Intl.DateTimeFormat('bs-BA', { month: 'long', year: 'numeric' });
const initialMonthLabel = formatter.format(initialDate);
const capitalizedLabel = initialMonthLabel.charAt(0).toUpperCase() + initialMonthLabel.slice(1);
const today = new Date();
---

<calendar-widget>
  <!-- We put data-events on this div so script can read it easily -->
  <div
    class={`card shadow-sm calendar-widget ${className || ''}`}
    data-year={year}
    data-month={month}
    data-events={JSON.stringify(serializedEvents)}
  >
    <!-- Calendar Header -->
  </div>
</calendar-widget>
